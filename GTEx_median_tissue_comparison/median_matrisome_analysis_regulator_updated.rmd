---
title: "matrisome_median_analysis"
author: "Tim Nieuwenhuis"
date: "11/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(pheatmap)

load("median_gtex_v8.rda")

#Select v8 or v7
#median_tpm <- read.csv("median_tpm_v7.csv", stringsAsFactors = F)
median_tpm <- read.csv("median_tpm_v8.csv", stringsAsFactors = F)


## Read in matrisome data
matrisome_tab <- read.csv("matrisome_hs_masterlist_EDIT_r.csv", stringsAsFactors = F)
colnames(matrisome_tab)[1] <- "Division"

matrisome_tab <- matrisome_tab %>% filter(Division != "Retired")

core_tab <- filter(matrisome_tab, Division == "Core matrisome")

assoc_tab <- filter(matrisome_tab, Division == "Matrisome-associated")

core_n_reg_tab <- filter(matrisome_tab, Division == "Core matrisome" | Category == "ECM Regulators")


matrisome_tab[1:3,1:3]

  ## Read in name translator
  ## The name translator actually comes from the the chunck named clust_order
#gtex_dict <- read.csv("input/matrisome_clustered_tiss_names_abrv.csv")
gtex_dict <- read.csv("input/ordered_all_tiss_mat_names.csv")

```


```{r cars}
rownames(median_dat) <- gtab$gene_name
median_dat[1:3,1:3]

#Filter to matrisome
ind <- rownames(median_dat) %in% matrisome_tab$Gene.Symbol

median_dat_matrisome <- median_dat[ind,]

#Filter to core

ind <- rownames(median_dat) %in% core_tab$Gene.Symbol 

median_dat_core <- median_dat[ind,]

#Filter to assoc

ind <- rownames(median_dat) %in% assoc_tab$Gene.Symbol 

median_dat_assoc <- median_dat[ind,]

#Filter to core_n_reg

ind <- rownames(median_dat) %in% core_n_reg_tab$Gene.Symbol 

median_dat_core_n_reg <- median_dat[ind,]


```


Cluster tissues
```{r}
#All matrisome
matrisome_cor <- cor(median_dat_matrisome, method = "kendall")


pheatmap(matrisome_cor,
                
                main="All matrisome", fontsize=5, fontsize_row=5, fontsize_col=5,
                filename="all_matrisome_correlation_v8.pdf",
                width=7, height=7)

#Core matrisome
core_cor <- cor(median_dat_core, method = "kendall")

pheatmap(core_cor,
                
                main="Core Matrisome", fontsize=5, fontsize_row=5, fontsize_col=5,
                filename="core_matrisome_correlation_v8.pdf",
                width=7, height=7)

#New core
core_n_reg_cor <- cor(median_dat_core_n_reg, method = "kendall")
dendo <- hclust(d=as.dist(1-(core_n_reg_cor)), method = "average")

 ##Rename
length (colnames(core_n_reg_cor)) ==  length(gtex_dict$official_name)
map <- match(colnames(core_n_reg_cor), gtex_dict$official_name)
colnames(core_n_reg_cor) <- gtex_dict$abrreviated[map]
rownames(core_n_reg_cor) <- gtex_dict$abrreviated[map]

 ## Make the heatmap

pheatmap(core_n_reg_cor,
                cluster_rows = dendo, cluster_cols = dendo, 

                main="Core Marisomes and ECM Regulator", fontsize=5, fontsize_row=5, fontsize_col=5,
               filename="output/core_n_reg_matrisome_correlation_v8.pdf",
                width=7.2, height=7)

dendo_all_tiss_order <- dendo$labels[(dendo$order)]

#Produce all ordered
gtex_dict_n_brain <- filter(gtex_dict, official_name != "Brain")
map <- match(gtex_dict_n_brain$official_name, dendo_all_tiss_order)
ordered_gtex_dict <- gtex_dict[map,]

write.csv(ordered_gtex_dict, "output/ordered_all_tiss_mat_names.csv",
          row.names = F)



```

Brain Collapse
```{r}
 ## Pull out brain
brain_all <- median_dat_matrisome[,startsWith(colnames(median_dat_matrisome),
                                              prefix = "Brain")]
 ## Mean brain
mean_brain <- rowMeans(brain_all)

 ## Remove brain
median_dat_mat_no_brain <- median_dat_matrisome[,!startsWith(colnames(median_dat_matrisome),
                                              prefix = "Brain")]
 ## Add brain to data
cllpse_brain_dat <- cbind(median_dat_mat_no_brain, mean_brain)

colnames(cllpse_brain_dat)[ncol(cllpse_brain_dat)] <- "Brain"


 ## Brain correlation
cllpse_brain_cor <- cor(cllpse_brain_dat, method = "kendall")
dendo <- hclust(d=as.dist(1-(cllpse_brain_cor)), method = "average")


 ##Rename
map <- match(colnames(cllpse_brain_cor), gtex_dict$official_name)
colnames(cllpse_brain_cor) <- gtex_dict$abrreviated[map]
rownames(cllpse_brain_cor) <- gtex_dict$abrreviated[map]

 ## Make the heatmap

plot <- pheatmap(cllpse_brain_cor,
                main="Core Marisomes and ECM Regulator Collapsed Brain",
                fontsize=5, fontsize_row=5, fontsize_col=5,
                cluster_cols = dendo, cluster_rows = dendo,
               filename="output/core_n_reg_clpse_brain_correlation_v8.pdf",
                width=7.2, height=7)

  ##
ordered_brain_vect <- dendo$labels[(dendo$order)]

ordered_brain <-  vapply(ordered_brain_vect, function(x){
                          temp <- match(x, gtex_dict$official_name)
                          gtex_dict$abrreviated[temp]
                        }, character(1))

#Produce brain collapse ordered
gtex_dict_col_brain <- filter(gtex_dict, !startsWith(official_name, "Brain -"))
map <- match(ordered_brain_vect, gtex_dict_col_brain$official_name)
ordered_gtex_dict <- gtex_dict_col_brain[map,]

write.csv(ordered_gtex_dict, "output/ordered_all_col_brain_mat_names.csv",
          row.names = F)

ind <- colnames(cllpse_brain_cor) %in% c("ADPSBQ", "ADPVSC",
                                  "SKINNS", "SKINS",
                                  "ARTTBL", "ARTCRN", "ARTAORT")
cllpse_brain_cor[ind,ind]


ind <- colnames(cllpse_brain_cor) %in% c("ARTTBL", "ARTCRN", "ARTAORT")

min(cllpse_brain_cor[ind,ind])
```


Percent transcriptome tpm core vs assoc
```{r}
colsum_tpm <- colSums(median_tpm[,-1])

core_med_tpm <- colSums(filter(median_tpm, Description %in% core_tab$Gene.Symbol)[,-1])/colsum_tpm

#assoc_med_tpm <- colSums(filter(median_tpm, Description %in% assoc_tab$Gene.Symbol)[,-1])/colsum_tpm

assoc_med_tpm <- colSums(filter(median_tpm, Description %in% filter(assoc_tab, Category == "ECM Regulators")[,3])[,-1])/colsum_tpm
names(assoc_med_tpm) <- colnames(median_dat)

core_med_tpm <- enframe(core_med_tpm) 
core_med_tpm$type <- "Core Matrisome"


assoc_med_tpm <- enframe(assoc_med_tpm)
assoc_med_tpm$type <- "ECM Regulators"

percent_dat <- rbind(core_med_tpm, assoc_med_tpm)

#percent_dat$name <- factor(x =colnames(median_dat), levels = rev(unique(colnames(median_dat))) )

ggplot(percent_dat) +
  geom_bar(aes(y = value, x = name, fill = type), stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Percent TPM of Transcriptome",
       x = "Tissues") +
  scale_fill_discrete(name = "Protein Type") +
  coord_flip(ylim=c(0,.125)) 


ggsave(filename = "percent_transcriptome_matrisome_v8.pdf", width = 10, height = 10)

```

Percent transcriptome core types and regulators

```{r}
core_types <- unique(core_n_reg_tab$Category)

glyco_percent <- colSums(filter(median_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[1])[,3])[,-1])/colsum_tpm

glyco_percent <- enframe(glyco_percent) 
glyco_percent$type <- core_types[1]

  
collagen_percent <- colSums(filter(median_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[2])[,3])[,-1])/colsum_tpm

collagen_percent <- enframe(collagen_percent) 
collagen_percent$type <- core_types[2]
  
proteoglycan_percent <- colSums(filter(median_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[3])[,3])[,-1])/colsum_tpm

proteoglycan_percent <- enframe(proteoglycan_percent) 
proteoglycan_percent$type <- core_types[3]

#Adding regulators
regulator_percent <- colSums(filter(median_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[4])[,3])[,-1])/colsum_tpm

regulator_percent <- enframe(regulator_percent) 
regulator_percent$type <- core_types[4]


core_percent <- rbind(glyco_percent, collagen_percent, proteoglycan_percent,regulator_percent)

 ## Ordered on composition, maybe change to ordered by alphabetical?
core_percent$type <- factor(x = core_percent$type,
                            levels = c("ECM Regulators",
                                       "Proteoglycans",
                                       "Collagens",
                                       "ECM Glycoproteins"))

  ## Ordering tissues on clustering from above and turning their names into abbreviations
  ## Rename current IDs to fit R names
core_percent$name <- str_replace_all(core_percent$name, "[.][.][.]", "_")
core_percent$name <- str_replace_all(core_percent$name, "[.][.]", "__")
core_percent$name <- str_replace_all(core_percent$name, "[.]$", "")
core_percent$name <- str_replace_all(tolower(core_percent$name), "[.]", "_")
  ##Use dictionary to rename
map <- match(core_percent$name, gtex_dict$r_names)
core_percent$abbrev <- factor(gtex_dict$abrreviated[map], levels = gtex_dict$abrreviated)

#core_percent$name <- factor(x = colnames(median_dat), levels = rev(unique(colnames(median_dat))) )

ggplot(core_percent) +
  geom_bar(aes(y = value, x = abbrev, fill = type), stat = "identity",width=0.8) +
  scale_y_continuous(labels = scales::percent) +
  #coord_cartesian(xlim = c(0,15)) +
  coord_flip(
    #ylim = c(0,.13)
    ) +
  labs(y = "Percent TPM of Transcriptome",
       x = "Tissues",
       fill = "Matrisome Divisions") +
  scale_fill_discrete(name = "Protein Type") +
  scale_fill_manual(values = c("#E1BE6A",  "#994F00", "#E66100", "#5D3A9B")) +
    #geom_text(x=40, y=.10, label=paste0("Goes to ", round(sum(filter(core_percent, name == "Pancreas")[,2]), 3)*100, "%" )) +
  theme_classic(base_size = 15) +
  theme(axis.text.x= element_text(size = 16), legend.position = "top")

ggsave(filename = "percent_transcriptome_core_n_reg_matrisome_v8.pdf", width = 10, height = 10)
```


As above but with collapsing the brain

```{r}
core_types <- unique(core_n_reg_tab$Category)

  ##  Brain collapse
#colnames(median_tpm)
brain_tpm <- median_tpm[,startsWith(colnames(median_tpm),
                                              prefix = "Brain")]
mean_brain_tpm <- rowMeans(brain_tpm)

mean_no_brain_tpm <- median_tpm[,!startsWith(colnames(median_tpm),
                                              prefix = "Brain")]
cllpse_brain_tpm <- cbind(mean_no_brain_tpm, mean_brain_tpm)

colnames(cllpse_brain_tpm)[ncol(cllpse_brain_tpm)] <- "Brain"

  ## Collapse ends

  ##Making new variables for no brain
  colsum_tpm <- colSums(cllpse_brain_tpm[,-1])


glyco_percent <- colSums(filter(cllpse_brain_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[1])[,3])[,-1])/colsum_tpm

glyco_percent <- enframe(glyco_percent) 
glyco_percent$type <- core_types[1]

  
collagen_percent <- colSums(filter(cllpse_brain_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[2])[,3])[,-1])/colsum_tpm

collagen_percent <- enframe(collagen_percent) 
collagen_percent$type <- core_types[2]
  
proteoglycan_percent <- colSums(filter(cllpse_brain_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[3])[,3])[,-1])/colsum_tpm

proteoglycan_percent <- enframe(proteoglycan_percent) 
proteoglycan_percent$type <- core_types[3]

#Adding regulators
regulator_percent <- colSums(filter(cllpse_brain_tpm, Description %in% filter(core_n_reg_tab, Category == core_types[4])[,3])[,-1])/colsum_tpm

regulator_percent <- enframe(regulator_percent) 
regulator_percent$type <- core_types[4]


core_percent <- rbind(glyco_percent, collagen_percent, proteoglycan_percent,regulator_percent)

 ## Ordered on composition, maybe change to ordered by alphabetical?
core_percent$type <- factor(x = core_percent$type,
                            levels = c("ECM Regulators",
                                       "Proteoglycans",
                                       "Collagens",
                                       "ECM Glycoproteins"))

  ## Ordering tissues on clustering from above and turning their names into abbreviations
  ## Rename current IDs to fit R names
core_percent$name <- str_replace_all(core_percent$name, "[.][.][.]", "_")
core_percent$name <- str_replace_all(core_percent$name, "[.][.]", "__")
core_percent$name <- str_replace_all(core_percent$name, "[.]$", "")
core_percent$name <- str_replace_all(tolower(core_percent$name), "[.]", "_")
  ##Use dictionary to rename
map <- match(core_percent$name, gtex_dict$r_names)
core_percent$abbrev <- factor(gtex_dict$abrreviated[map], levels = rev(ordered_brain))

#core_percent$name <- factor(x = colnames(median_dat), levels = rev(unique(colnames(median_dat))) )

ggplot(core_percent) +
  geom_bar(aes(y = value, x = abbrev, fill = type), stat = "identity",width=0.8) +
  scale_y_continuous(labels = scales::percent) +
  #coord_cartesian(xlim = c(0,15)) +
  coord_flip(
    #ylim = c(0,.13)
    ) +
  labs(y = "Percent TPM of Transcriptome",
       x = "Tissues",
       fill = "Matrisome Divisions") +
  scale_fill_discrete(name = "Protein Type") +
  scale_fill_manual(values = c("#E1BE6A",  "#994F00", "#E66100", "#5D3A9B")) +
    #geom_text(x=40, y=.10, label=paste0("Goes to ", round(sum(filter(core_percent, name == "Pancreas")[,2]), 3)*100, "%" )) +
  theme_classic(base_size = 15) +
  theme(axis.text.x= element_text(size = 16), legend.position = "top")

ggsave(filename = "output/percent_transcriptome_brain_collapse_core_n_reg_matrisome_v8.pdf", width = 10, height = 10)
```



How much of pancreas expression is PRSS1 and PRSS2?

```{r}
panc_dat <- median_tpm %>% select( Description,Pancreas)

enzymes <- panc_dat %>% filter(Description %in% c("PRSS1", "PRSS2", "REG1A", "CELA3A"))

sum(enzymes$Pancreas)/sum(panc_dat$Pancreas)

#V7 test

median_tpm_v7 <- read.csv("median_tpm_v7.csv", stringsAsFactors = F)

panc_dat <- median_tpm_v7 %>% select( Description,Pancreas)

enzymes <- panc_dat %>% filter(Description %in% c("PRSS1", "PRSS2", "REG1A", "CELA3A"))

sum(enzymes$Pancreas)/sum(panc_dat$Pancreas)

```


Tissue clustering order from core and regulatory matrisome
```{r clust_order}
tiss_translator <- read.csv("input/gtex_name_translator.csv")


tiss_clust <- hclust(d=as.dist(1-abs(core_n_reg_cor)), method = "average")

plot(tiss_clust)
ordered_cluster <- tiss_clust$labels[tiss_clust$order]
matrisome_ord_translator <- tiss_translator[match(ordered_cluster,tiss_translator$official_name),]
write.csv(matrisome_ord_translator, "output/matrisome_clustered_tiss_names.csv", row.names = F)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
